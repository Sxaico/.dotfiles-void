#!/bin/sh
set -eu

APP="$1"  # ruta al .AppImage pasada por xdg-open/Dolphin
APPS="$HOME/Applications"
DESKDIR="$HOME/.local/share/applications"
ICODIR="$HOME/.local/share/icons/appimages"

mkdir -p "$APPS" "$DESKDIR" "$ICODIR"
chmod +x "$APP" 2>/dev/null || true

BASE="$(basename "$APP")"
DEST="$APPS/$BASE"
if [ "$APP" != "$DEST" ]; then
  [ -e "$DEST" ] && DEST="$APPS/${BASE%.AppImage}-$(date +%Y%m%d-%H%M%S).AppImage"
  mv -f "$APP" "$DEST"
fi

TMP="$(mktemp -d)"
trap 'rm -rf "$TMP"' EXIT
( cd "$TMP" && "$DEST" --appimage-extract >/dev/null 2>&1 || true )

NAME="$(basename "$DEST" .AppImage)"
INNER_DESK="$(find "$TMP/squashfs-root" -maxdepth 2 -name '*.desktop' | head -n1 || true)"
if [ -n "${INNER_DESK:-}" ] && [ -f "$INNER_DESK" ]; then
  N2="$(grep -m1 '^Name=' "$INNER_DESK" | cut -d= -f2- || true)"
  [ -n "${N2:-}" ] && NAME="$N2"
fi

ICON_DST=""
if [ -f "$TMP/squashfs-root/.DirIcon" ]; then
  ICON_DST="$ICODIR/$(basename "$DEST").png"
  cp -f "$TMP/squashfs-root/.DirIcon" "$ICON_DST"
fi

DESK="$DESKDIR/$(basename "$DEST").desktop"
{
  echo "[Desktop Entry]"
  echo "Type=Application"
  printf 'Name=%s\n' "$NAME"
  printf 'Exec=%s %%U\n' "$DEST"
  printf 'TryExec=%s\n' "$DEST"
  [ -n "$ICON_DST" ] && printf 'Icon=%s\n' "$ICON_DST"
  echo "Terminal=false"
  echo "Categories=Utility;"
  echo "X-AppImage-Integrate=true"
  echo "NoDisplay=false"
} > "$DESK"

command -v update-desktop-database >/dev/null 2>&1 && \
  update-desktop-database "$DESKDIR" >/dev/null 2>&1 || true

command -v notify-send >/dev/null 2>&1 && \
  notify-send "AppImage" "Integrado: $NAME"

exec "$DEST"

